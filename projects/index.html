<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Paper Galaxy – Star-Scaled Spheres</title>
  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.164.0/build/three.module.js"
    }
  }
  </script>
  <style>
    html, body, #root {
      margin: 0; width: 100%; height: 100%; overflow: hidden;
      background: #080810;
    }
    #highlight {
      position: fixed; top: 20px; left: 20px;
      padding: 8px; background: rgba(0,0,0,0.6);
      color: #fff; border-radius: 6px;
      font-family: sans-serif; pointer-events: none;
      display: none; max-width: 500px;
      line-height: 1.4; font-size: 10px;
    }
    #regionTag {
      position: fixed; bottom: 20px; left: 50%;
      transform: translateX(-50%);
      padding: 6px 12px; background: rgba(0,0,0,0.6);
      color: #fff; border-radius: 4px;
      font-family: sans-serif; pointer-events: none;
      font-size: 20px;
    }
    #crosshair {
      position: fixed; top: 50%; left: 50%;
      width: 20px; height: 20px; pointer-events: none;
      transform: translate(-50%, -50%);
    }
    #crosshair:before, #crosshair:after {
      content: ""; position: absolute; background: rgba(255,255,255,0.7);
    }
    #crosshair:before {
      left:50%; top:0; width:1px; height:100%; transform:translateX(-50%);
    }
    #crosshair:after {
      top:50%; left:0; height:1px; width:100%; transform:translateY(-50%);
    }
    #readme {
      position: fixed; top:20px; right:20px;
      width:400px; padding:12px; background:rgba(0,0,0,0.7);
      color:#fff; border-radius:6px; font-family:sans-serif;
      line-height:1.4; z-index:10;
    }
    #readme-close {
      position:absolute; top:8px; right:10px;
      cursor:pointer; font-size:25px; color:#fff;
    }
    #readme-content {
      margin-top:4px; font-size:16px;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <div id="highlight"></div>
  <div id="regionTag"></div>
  <div id="crosshair"></div>
  <div id="readme">
    <div id="readme-close">×</div>
    <div id="readme-content">
      This visualization is generated by vectorizing the abstract of each paper and projecting into 3D space using a dimensionality reduction algorithm.<br>
      <b>Try to move the mouse on the STARs!</b><br>
      <a href="https://github.com/Srameo/my-soarxiv" target="_blank" style="color:#88caff;">Github Repo</a><br><br>
      <i><b style="color: #ffeeaa;">Yellow (hex code 0xffeeaa)</b> denotes first authorship, and each star’s size is proportional to its GitHub star count.</i>
    </div>
  </div>

  <script type="module">
    import * as THREE          from 'three';
    import { OrbitControls }   from 'https://unpkg.com/three@0.164.0/examples/jsm/controls/OrbitControls.js';
    import { EffectComposer }  from 'https://unpkg.com/three@0.164.0/examples/jsm/postprocessing/EffectComposer.js';
    import { RenderPass }      from 'https://unpkg.com/three@0.164.0/examples/jsm/postprocessing/RenderPass.js';
    import { UnrealBloomPass } from 'https://unpkg.com/three@0.164.0/examples/jsm/postprocessing/UnrealBloomPass.js';

    const scene    = new THREE.Scene();
    scene.background = new THREE.Color(0x080810);
    scene.fog        = new THREE.FogExp2(0x080810, 0.0025);

    const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 500);
    camera.position.set(0, 0, 50);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(innerWidth, innerHeight);
    document.getElementById('root').appendChild(renderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor  = 0.05;

    // 星空背景
    (function addStarField(count = 3000) {
      const geo = new THREE.BufferGeometry();
      const pos = new Float32Array(count * 3);
      for (let i = 0; i < count; i++) {
        pos[3*i]   = (Math.random() - 0.5) * 400;
        pos[3*i+1] = (Math.random() - 0.5) * 400;
        pos[3*i+2] = (Math.random() - 0.5) * 400;
      }
      geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
      const mat = new THREE.PointsMaterial({ color: 0xffffff, size: 0.7, transparent: true, opacity: 0.8 });
      scene.add(new THREE.Points(geo, mat));
    })();

    // 光源 & Bloom
    scene.add(new THREE.HemisphereLight(0x334455, 0x111122, 0.4));
    const dir = new THREE.DirectionalLight(0xffeeaa, 0.6);
    dir.position.set(10, 20, 10);
    scene.add(dir);
    const composer = new EffectComposer(renderer);
    composer.addPass(new RenderPass(scene, camera));
    composer.addPass(new UnrealBloomPass(new THREE.Vector2(innerWidth, innerHeight), 0.8, 0.3, 0.85));

    // 悬浮高亮环
    const ringGeo = new THREE.RingGeometry(0.18, 0.2, 48);
    const ringMat = new THREE.MeshBasicMaterial({ color: 0xffffff, side: THREE.DoubleSide, transparent: true, opacity: 0.8 });
    const highlightRing = new THREE.Mesh(ringGeo, ringMat);
    highlightRing.visible = false;
    scene.add(highlightRing);

    // 加载数据 & 动态缩放
    const spheres = [];
    const BASE_RADIUS = 0.08;
    fetch('galaxy.json')
      .then(res => res.json())
      .then(data => {
        // 并行获取 GitHub star 数
        const starPromises = data.map(p => {
          if (p.github_url) {
            try {
              const url = new URL(p.github_url);
              const [owner, repo] = url.pathname.slice(1).split('/');
              return fetch(`https://api.github.com/repos/${owner}/${repo}`)
                .then(r => r.json())
                .then(js => js.stargazers_count || 0)
                .catch(() => 0);
            } catch {
              return Promise.resolve(0);
            }
          } else {
            return Promise.resolve(null);
          }
        });

        Promise.all(starPromises).then(starCounts => {
          const validStars = starCounts.filter(s => s !== null);
          const minStars = validStars.length ? Math.min(...validStars) : 0;
          const maxStars = validStars.length ? Math.max(...validStars) : minStars;
          const sphereGeo = new THREE.SphereGeometry(BASE_RADIUS, 16, 16);

          data.forEach((p, i) => {
            const isXin = p.authors[0] === 'Xin Jin';
            const mat = new THREE.MeshStandardMaterial({
              color:   isXin ? 0xff6622 : 0x777777,
              emissive:isXin ? 0xffeeaa : 0xffffff,
              emissiveIntensity: isXin ? 1.8 : 1.2,
              roughness:0.1, metalness:0.1
            });

            const mesh = new THREE.Mesh(sphereGeo, mat);
            // 附加 star 数到 userData
            mesh.userData = { ...p, stars: starCounts[i] || 0 };

            // 根据 star 数线性映射到 [1, 1.5]
            let scale = 1;
            const stars = starCounts[i];
            if (stars !== null && maxStars > minStars) {
              scale = 1 + ((Math.log(stars) - Math.log(minStars)) / (Math.log(maxStars) - Math.log(minStars))) * 1.0;
            }
            mesh.scale.set(scale, scale, scale);

            mesh.position.set(...p.pos);
            scene.add(mesh);
            spheres.push(mesh);
          });

          // 自动对齐相机和控制中心
          const center = new THREE.Vector3();
          data.forEach(p => center.add(new THREE.Vector3(...p.pos)));
          center.divideScalar(data.length);
          camera.position.copy(center.clone().add(new THREE.Vector3(0, 0, 6)));
          controls.target.copy(center);
          controls.update();
        });
      })
      .catch(err => console.error(err));

    // 交互 & 高亮 & 区域标签
    const raycaster = new THREE.Raycaster();
    const pointer   = new THREE.Vector2();
    const hl        = document.getElementById('highlight');
    const regionTag = document.getElementById('regionTag');
    const readme    = document.getElementById('readme');
    const closeBtn  = document.getElementById('readme-close');

    closeBtn.addEventListener('click', () => readme.style.display = 'none');
    renderer.domElement.addEventListener('pointermove', e => {
      const rect = renderer.domElement.getBoundingClientRect();
      pointer.x =  ((e.clientX - rect.left) / rect.width) * 2 - 1;
      pointer.y = -((e.clientY - rect.top)  / rect.height) * 2 + 1;
    });
    renderer.domElement.addEventListener('click', () => {
      raycaster.setFromCamera(pointer, camera);
      const hit = raycaster.intersectObjects(spheres)[0];
      if (hit && hit.object.userData.homepage) {
        window.open(hit.object.userData.homepage, '_blank');
      }
    });

    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      if (spheres.length) {
        raycaster.setFromCamera(pointer, camera);
        const hit = raycaster.intersectObjects(spheres)[0];
        let activeSphere;
        if (hit) {
          activeSphere = hit.object;
        } else {
          let minDist = Infinity;
          spheres.forEach(m => {
            const v = m.position.clone().project(camera);
            const d = Math.hypot(v.x - pointer.x, v.y - pointer.y);
            if (d < minDist) { minDist = d; activeSphere = m; }
          });
        }
        if (activeSphere) {
          const d = activeSphere.userData;
          hl.style.display = 'block';
          hl.innerHTML = `
            <b>${d.title}</b><br>
            <i>${d.published}</i><br>
            ${d.authors.join(', ')}<br>
            ${d.teaser}<br>
            ${d.stars > 0 ? `⭐️ ${d.stars} Stars<br>` : ''}
            <a href="${d.url}" target="_blank" style="color:#88caff;">Click Star to View Homepage!</a>
          `;
          highlightRing.visible = true;
          highlightRing.position.copy(activeSphere.position);
          highlightRing.lookAt(camera.position);
          regionTag.textContent = d.tags?.[0] ? `Research Region: ${d.tags[0]}` : '';
        } else {
          hl.style.display = 'none';
          highlightRing.visible = false;
          regionTag.textContent = '';
        }
      }
      composer.render();
    }
    animate();

    window.addEventListener('resize', () => {
      camera.aspect = innerWidth / innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(innerWidth, innerHeight);
      composer.setSize(innerWidth, innerHeight);
    });
  </script>
</body>
</html>